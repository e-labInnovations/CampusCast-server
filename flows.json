[
    {
        "id": "fd8e8b6fa29d6f79",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3ce080af1180e0bb",
        "type": "websocket-listener",
        "path": "/",
        "wholemsg": "false"
    },
    {
        "id": "7540fc1a.916874",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "Fetch Announcements",
        "func": "var firebaseAdmin = global.get('firebaseAdmin');\nconst configData = 'eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6ImNhbXB1c2Nhc3QtZWxhYmlucyIsInByaXZhdGVfa2V5X2lkIjoiMWZkYzY4NTFjOGRhYWFhM2UyYjlmMzZmZDRkOTNiYWZlYzI2ZjY4YiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM5Q3g1ZTZFTktjZVB3XG5LcGcwT2Y0MVIwYXVaQ2I1aDdHU0lBdEliaEJoZmdEUlNrL2R5WERlYmw2cmRyNXQ1dmpEY2dvZW04cVA5T0YyXG5nRHBkUVZ6dUtiKzNiY093Z2N4b3F6KzQ3dXVRZGlQSXY3cFBoWU1ZNW9mUEF0YjJHV1pFV29GOWIyUDgwbUo4XG5NUzA5NWxHNjJieDNzWUtYeFBseDk5eXo2dTVwNVZIS3A1YWZhZXZMUjU0VTdnaXY0bU03UVVwWTVydG9ZZm5FXG5jV05wRTNDaU8rdmlidW9KRktYaFNDQjlRZzUxanlwRmVBTHFBeWZDS0pXcktBT2ZXZW9XOExKNlNXRCtpcTNWXG5yKzc5WHRYeU16ODNETkdqSXV3NVdWOWIzWFUvVWdxVlBkVkFyblZ4aVR6MWs5cmxPOHlwYTErMHl1U1lEM2tSXG54cXB1akRCcEFnTUJBQUVDZ2dFQUtxc3ZDblJwdGN5aGltU08wS0R6VmdLMXV5aDdYSkNLWGFWU2JxRjdISW8wXG5kSWpOb0kxMlpwb3FUNURBZUMxdElpNGtCeGNhWUNaQlduNGtUa2F4eTBiTWtVSWE3SVRMaHFkNmZVc2VDOUFDXG5rUzNuUjBvbkZqQjRZRnJ2ZW9JdW9VaDlXRHJUYW0zeEVUK0hTdVNvdDJBc2FDYStoM09MNnZPclVzZTQwdGt1XG5aVk1DMktNdXNhdU0yRERHUnlFQWN3WWl0M0EwVDFvYlVEZ1oydnEzK1c5UXZHY0NLRHBGSDlqQk1tOVFkUUo1XG5qMWlMd0QrdlhldHcxaDVtNkdkeW1BMXR6ajRLUmI5QU9oZEY2cDdKcHg5QVgrN2RzKzV1TllTRzlqWUFvalNUXG5xTjRKOFRmSnZFbHpOVEUweVhQaFhQV3hiVGgxWjlIbFc1bTZ4R0NabFFLQmdRRHRhNHZ0ZVpwaEFJNEx6akRXXG5ITkF5SXV3YjdGMFNyQVZMUnNqYjNtZ0xBdStNSHVHem9Da3FuQjB6ODRMdnlmOU1WWUF6cnJ1YStyQWhnSy9vXG5XMmk5cjRxOEtOQ0xSWndCaUNENko3NlU3dCtsc3pvTXVtM3c3dVpsanA4RmlKek5LR1JmemhPWE10WmVzVmpuXG5iUVN3NlhJaksvajdGSkszNmpRc0lLQ3l4UUtCZ1FETDFtWG9DVlFKeWR3VFlLcVBKTUJMOW5WWmhqRUMrNi84XG51MG1wMGVKSDBvZGZjYnRIOGh6cVZnZk41ZkVSWFZlOXdDcC9ocjYzRmt1dzFpM0NCMHg4ZFhOZVVFTmpZeVR3XG5Cb1pEbm9QQ05mckhkdVpqVGYxNG45YkUyVXRIeDY2T3hUZHo4anhCVFFlTVgrd0VZU1cyNE5NTU1NMURZcEwxXG50c3hVUmliUlZRS0JnUUNIUWJXOTNJRXVzZm82ajRVUzllZEdLTThLT1dYc3RVTnUxeXltMWRYQU1EUDRSNytkXG5iYWtHTlZvTnRyVHBsdEp5MG1MdkRxU2liaDdaZDA2L3VSTzZ2TDcwNHV1cjdFUXNPemxPU2tZdzRzVld5UHhSXG5OQVJlTmp2YnI1eTRzbE5pTFpqQlc4MmRYY0R5d1dZOHNjYnlZb3c3clZseThRMkU2VkEvczNiWllRS0JnUURMXG55MEE1bkZIME0yaWZ5dzdiYktBQmtwaEMrR0k2SEU4WWZGdXF1SmZtdlByeGx2RHFmb3NnVXdFY2YxL2t2NUZBXG51a2NERjBISUpUZHB4c2thNjFjeU8rOHJoVTNLcVU0OTJCZ1d0UDRBaHgyQ25VSzhXRFlxaW93Y1pTL1p4UytsXG51RkczejZFa25KSUdhOFM1b0RNbncySGVGMUN4cFhWT3l3TkE0cDVldlFLQmdIdzZwUWJXazM4S2RqUmNPNEo3XG5QYmxMMUxvcVZIOVhhRVQ3NWs1N3F4K0F5ZWYyQWlYSDh5emxxeTVCbFc2d2NpZTNSc0M1emtYc2JoZlFBWFdtXG5LbjhFQzZUcm9FenZkb0NWU2tKRk1qb3B5V2tPR0RDTTZEYnVYbWxmY1V3ZlVtSXdyVUJpTzBZNnRZam0xZGNJXG5mMkZpSWtHRi9PTVdzSHh5aFNXSmIrWmFcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsImNsaWVudF9lbWFpbCI6ImZpcmViYXNlLWFkbWluc2RrLXB3eGR2QGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImNsaWVudF9pZCI6IjEwMjYzMTI5MTMwMTUzMjU1NzAwMyIsImF1dGhfdXJpIjoiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCJ0b2tlbl91cmkiOiJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsImNsaWVudF94NTA5X2NlcnRfdXJsIjoiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay1wd3hkdiU0MGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSJ9'\n\nif (firebaseAdmin.apps.length === 0) {\n    firebaseAdmin.initializeApp({\n        credential: firebaseAdmin.credential.cert(\n            JSON.parse(Buffer.from(configData, 'base64').toString('ascii'))),\n    });\n}\n\nconst firestore = firebaseAdmin.firestore()\n// firestore.collection('announcements')\n//     .onSnapshot(snap => {\n//         snap.docChanges().forEach(change => {\n//             var message = change.doc.data()\n//             node.send(message);\n//         })\n//     })\n\n// firestore.collection('test_announcements').get().then((querySnapshot) => {\n//     querySnapshot.forEach((doc) => {\n//         console.log(doc.id, ' => ', doc.data());\n//     });\n// }).catch((error) => {\n//     console.error('Error getting documents: ', error);\n// });\n\nfirestore.collection('announcements')\n    .where('isSend', '==', false)\n    .onSnapshot(snap => {\n        snap.docChanges().forEach(change => {\n            if (change.type === \"added\") {\n                msg.payload = change.doc\n                node.send(msg);\n            }\n        })\n    })\n\n// const db = firebaseAdmin.firestore();\n// const announcementsRef = db.collection('announcements');\n\n// db.collection(\"announcements\").doc(\"k6UIbKUA0UbNbcJDDQi3\")\n//     .onSnapshot((doc) => {\n//         console.log(\"Current data: \", doc.data());\n//     });\n\n// const firestore = firebaseAdmin.firestore();\n\n// firestore.listCollections().then(collections => {\n//     collections.forEach(collection => {\n//         console.log('Collection:', collection.id);\n//     });\n// }).catch(error => {\n//     console.error('Error listing collections:', error);\n// });\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 60,
        "wires": [
            [
                "80b7665eaf40adb9"
            ]
        ],
        "outputLabels": [
            "1"
        ]
    },
    {
        "id": "2a4e826b.c9ae4e",
        "type": "inject",
        "z": "fd8e8b6fa29d6f79",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 60,
        "wires": [
            [
                "7540fc1a.916874"
            ]
        ]
    },
    {
        "id": "5501dffded061074",
        "type": "inject",
        "z": "fd8e8b6fa29d6f79",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 380,
        "wires": [
            [
                "479444429fceb3aa"
            ]
        ]
    },
    {
        "id": "479444429fceb3aa",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "function 1",
        "func": "msg.payload = Buffer.from(JSON.stringify({\n    \"type\": \"service_account\",\n    \"project_id\": \"campuscast-elabins\",\n    \"private_key_id\": \"1fdc6851c8daaaa3e2b9f36fd4d93bafec26f68b\",\n    \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC9Cx5e6ENKcePw\\nKpg0Of41R0auZCb5h7GSIAtIbhBhfgDRSk/dyXDebl6rdr5t5vjDcgoem8qP9OF2\\ngDpdQVzuKb+3bcOwgcxoqz+47uuQdiPIv7pPhYMY5ofPAtb2GWZEWoF9b2P80mJ8\\nMS095lG62bx3sYKXxPlx99yz6u5p5VHKp5afaevLR54U7giv4mM7QUpY5rtoYfnE\\ncWNpE3CiO+vibuoJFKXhSCB9Qg51jypFeALqAyfCKJWrKAOfWeoW8LJ6SWD+iq3V\\nr+79XtXyMz83DNGjIuw5WV9b3XU/UgqVPdVArnVxiTz1k9rlO8ypa1+0yuSYD3kR\\nxqpujDBpAgMBAAECggEAKqsvCnRptcyhimSO0KDzVgK1uyh7XJCKXaVSbqF7HIo0\\ndIjNoI12ZpoqT5DAeC1tIi4kBxcaYCZBWn4kTkaxy0bMkUIa7ITLhqd6fUseC9AC\\nkS3nR0onFjB4YFrveoIuoUh9WDrTam3xET+HSuSot2AsaCa+h3OL6vOrUse40tku\\nZVMC2KMusauM2DDGRyEAcwYit3A0T1obUDgZ2vq3+W9QvGcCKDpFH9jBMm9QdQJ5\\nj1iLwD+vXetw1h5m6GdymA1tzj4KRb9AOhdF6p7Jpx9AX+7ds+5uNYSG9jYAojST\\nqN4J8TfJvElzNTE0yXPhXPWxbTh1Z9HlW5m6xGCZlQKBgQDta4vteZphAI4LzjDW\\nHNAyIuwb7F0SrAVLRsjb3mgLAu+MHuGzoCkqnB0z84Lvyf9MVYAzrrua+rAhgK/o\\nW2i9r4q8KNCLRZwBiCD6J76U7t+lszoMum3w7uZljp8FiJzNKGRfzhOXMtZesVjn\\nbQSw6XIjK/j7FJK36jQsIKCyxQKBgQDL1mXoCVQJydwTYKqPJMBL9nVZhjEC+6/8\\nu0mp0eJH0odfcbtH8hzqVgfN5fERXVe9wCp/hr63Fkuw1i3CB0x8dXNeUENjYyTw\\nBoZDnoPCNfrHduZjTf14n9bE2UtHx66OxTdz8jxBTQeMX+wEYSW24NMMMM1DYpL1\\ntsxURibRVQKBgQCHQbW93IEusfo6j4US9edGKM8KOWXstUNu1yym1dXAMDP4R7+d\\nbakGNVoNtrTpltJy0mLvDqSibh7Zd06/uRO6vL704uur7EQsOzlOSkYw4sVWyPxR\\nNAReNjvbr5y4slNiLZjBW82dXcDywWY8scbyYow7rVly8Q2E6VA/s3bZYQKBgQDL\\ny0A5nFH0M2ifyw7bbKABkphC+GI6HE8YfFuquJfmvPrxlvDqfosgUwEcf1/kv5FA\\nukcDF0HIJTdpxska61cyO+8rhU3KqU492BgWtP4Ahx2CnUK8WDYqiowcZS/ZxS+l\\nuFG3z6EknJIGa8S5oDMnw2HeF1CxpXVOywNA4p5evQKBgHw6pQbWk38KdjRcO4J7\\nPblL1LoqVH9XaET75k57qx+Ayef2AiXH8yzlqy5BlW6wcie3RsC5zkXsbhfQAXWm\\nKn8EC6TroEzvdoCVSkJFMjopyWkOGDCM6DbuXmlfcUwfUmIwrUBiO0Y6tYjm1dcI\\nf2FiIkGF/OMWsHxyhSWJb+Za\\n-----END PRIVATE KEY-----\\n\",\n    \"client_email\": \"firebase-adminsdk-pwxdv@campuscast-elabins.iam.gserviceaccount.com\",\n    \"client_id\": \"102631291301532557003\",\n    \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\n    \"token_uri\": \"https://oauth2.googleapis.com/token\",\n    \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\n    \"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-pwxdv%40campuscast-elabins.iam.gserviceaccount.com\"\n})).toString('base64')\nconst configData = 'eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6ImNhbXB1c2Nhc3QtZWxhYmlucyIsInByaXZhdGVfa2V5X2lkIjoiMWZkYzY4NTFjOGRhYWFhM2UyYjlmMzZmZDRkOTNiYWZlYzI2ZjY4YiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM5Q3g1ZTZFTktjZVB3XG5LcGcwT2Y0MVIwYXVaQ2I1aDdHU0lBdEliaEJoZmdEUlNrL2R5WERlYmw2cmRyNXQ1dmpEY2dvZW04cVA5T0YyXG5nRHBkUVZ6dUtiKzNiY093Z2N4b3F6KzQ3dXVRZGlQSXY3cFBoWU1ZNW9mUEF0YjJHV1pFV29GOWIyUDgwbUo4XG5NUzA5NWxHNjJieDNzWUtYeFBseDk5eXo2dTVwNVZIS3A1YWZhZXZMUjU0VTdnaXY0bU03UVVwWTVydG9ZZm5FXG5jV05wRTNDaU8rdmlidW9KRktYaFNDQjlRZzUxanlwRmVBTHFBeWZDS0pXcktBT2ZXZW9XOExKNlNXRCtpcTNWXG5yKzc5WHRYeU16ODNETkdqSXV3NVdWOWIzWFUvVWdxVlBkVkFyblZ4aVR6MWs5cmxPOHlwYTErMHl1U1lEM2tSXG54cXB1akRCcEFnTUJBQUVDZ2dFQUtxc3ZDblJwdGN5aGltU08wS0R6VmdLMXV5aDdYSkNLWGFWU2JxRjdISW8wXG5kSWpOb0kxMlpwb3FUNURBZUMxdElpNGtCeGNhWUNaQlduNGtUa2F4eTBiTWtVSWE3SVRMaHFkNmZVc2VDOUFDXG5rUzNuUjBvbkZqQjRZRnJ2ZW9JdW9VaDlXRHJUYW0zeEVUK0hTdVNvdDJBc2FDYStoM09MNnZPclVzZTQwdGt1XG5aVk1DMktNdXNhdU0yRERHUnlFQWN3WWl0M0EwVDFvYlVEZ1oydnEzK1c5UXZHY0NLRHBGSDlqQk1tOVFkUUo1XG5qMWlMd0QrdlhldHcxaDVtNkdkeW1BMXR6ajRLUmI5QU9oZEY2cDdKcHg5QVgrN2RzKzV1TllTRzlqWUFvalNUXG5xTjRKOFRmSnZFbHpOVEUweVhQaFhQV3hiVGgxWjlIbFc1bTZ4R0NabFFLQmdRRHRhNHZ0ZVpwaEFJNEx6akRXXG5ITkF5SXV3YjdGMFNyQVZMUnNqYjNtZ0xBdStNSHVHem9Da3FuQjB6ODRMdnlmOU1WWUF6cnJ1YStyQWhnSy9vXG5XMmk5cjRxOEtOQ0xSWndCaUNENko3NlU3dCtsc3pvTXVtM3c3dVpsanA4RmlKek5LR1JmemhPWE10WmVzVmpuXG5iUVN3NlhJaksvajdGSkszNmpRc0lLQ3l4UUtCZ1FETDFtWG9DVlFKeWR3VFlLcVBKTUJMOW5WWmhqRUMrNi84XG51MG1wMGVKSDBvZGZjYnRIOGh6cVZnZk41ZkVSWFZlOXdDcC9ocjYzRmt1dzFpM0NCMHg4ZFhOZVVFTmpZeVR3XG5Cb1pEbm9QQ05mckhkdVpqVGYxNG45YkUyVXRIeDY2T3hUZHo4anhCVFFlTVgrd0VZU1cyNE5NTU1NMURZcEwxXG50c3hVUmliUlZRS0JnUUNIUWJXOTNJRXVzZm82ajRVUzllZEdLTThLT1dYc3RVTnUxeXltMWRYQU1EUDRSNytkXG5iYWtHTlZvTnRyVHBsdEp5MG1MdkRxU2liaDdaZDA2L3VSTzZ2TDcwNHV1cjdFUXNPemxPU2tZdzRzVld5UHhSXG5OQVJlTmp2YnI1eTRzbE5pTFpqQlc4MmRYY0R5d1dZOHNjYnlZb3c3clZseThRMkU2VkEvczNiWllRS0JnUURMXG55MEE1bkZIME0yaWZ5dzdiYktBQmtwaEMrR0k2SEU4WWZGdXF1SmZtdlByeGx2RHFmb3NnVXdFY2YxL2t2NUZBXG51a2NERjBISUpUZHB4c2thNjFjeU8rOHJoVTNLcVU0OTJCZ1d0UDRBaHgyQ25VSzhXRFlxaW93Y1pTL1p4UytsXG51RkczejZFa25KSUdhOFM1b0RNbncySGVGMUN4cFhWT3l3TkE0cDVldlFLQmdIdzZwUWJXazM4S2RqUmNPNEo3XG5QYmxMMUxvcVZIOVhhRVQ3NWs1N3F4K0F5ZWYyQWlYSDh5emxxeTVCbFc2d2NpZTNSc0M1emtYc2JoZlFBWFdtXG5LbjhFQzZUcm9FenZkb0NWU2tKRk1qb3B5V2tPR0RDTTZEYnVYbWxmY1V3ZlVtSXdyVUJpTzBZNnRZam0xZGNJXG5mMkZpSWtHRi9PTVdzSHh5aFNXSmIrWmFcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsImNsaWVudF9lbWFpbCI6ImZpcmViYXNlLWFkbWluc2RrLXB3eGR2QGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImNsaWVudF9pZCI6IjEwMjYzMTI5MTMwMTUzMjU1NzAwMyIsImF1dGhfdXJpIjoiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCJ0b2tlbl91cmkiOiJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsImNsaWVudF94NTA5X2NlcnRfdXJsIjoiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay1wd3hkdiU0MGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSJ9'\nconsole.log(JSON.parse(Buffer.from(configData, 'base64').toString('ascii')))\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 380,
        "wires": [
            [
                "0feb7ae52911d870"
            ]
        ]
    },
    {
        "id": "0feb7ae52911d870",
        "type": "debug",
        "z": "fd8e8b6fa29d6f79",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 420,
        "y": 380,
        "wires": []
    },
    {
        "id": "80b7665eaf40adb9",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "Update firebase",
        "func": "var firebaseAdmin = global.get('firebaseAdmin');\nconst configData = 'eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6ImNhbXB1c2Nhc3QtZWxhYmlucyIsInByaXZhdGVfa2V5X2lkIjoiMWZkYzY4NTFjOGRhYWFhM2UyYjlmMzZmZDRkOTNiYWZlYzI2ZjY4YiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM5Q3g1ZTZFTktjZVB3XG5LcGcwT2Y0MVIwYXVaQ2I1aDdHU0lBdEliaEJoZmdEUlNrL2R5WERlYmw2cmRyNXQ1dmpEY2dvZW04cVA5T0YyXG5nRHBkUVZ6dUtiKzNiY093Z2N4b3F6KzQ3dXVRZGlQSXY3cFBoWU1ZNW9mUEF0YjJHV1pFV29GOWIyUDgwbUo4XG5NUzA5NWxHNjJieDNzWUtYeFBseDk5eXo2dTVwNVZIS3A1YWZhZXZMUjU0VTdnaXY0bU03UVVwWTVydG9ZZm5FXG5jV05wRTNDaU8rdmlidW9KRktYaFNDQjlRZzUxanlwRmVBTHFBeWZDS0pXcktBT2ZXZW9XOExKNlNXRCtpcTNWXG5yKzc5WHRYeU16ODNETkdqSXV3NVdWOWIzWFUvVWdxVlBkVkFyblZ4aVR6MWs5cmxPOHlwYTErMHl1U1lEM2tSXG54cXB1akRCcEFnTUJBQUVDZ2dFQUtxc3ZDblJwdGN5aGltU08wS0R6VmdLMXV5aDdYSkNLWGFWU2JxRjdISW8wXG5kSWpOb0kxMlpwb3FUNURBZUMxdElpNGtCeGNhWUNaQlduNGtUa2F4eTBiTWtVSWE3SVRMaHFkNmZVc2VDOUFDXG5rUzNuUjBvbkZqQjRZRnJ2ZW9JdW9VaDlXRHJUYW0zeEVUK0hTdVNvdDJBc2FDYStoM09MNnZPclVzZTQwdGt1XG5aVk1DMktNdXNhdU0yRERHUnlFQWN3WWl0M0EwVDFvYlVEZ1oydnEzK1c5UXZHY0NLRHBGSDlqQk1tOVFkUUo1XG5qMWlMd0QrdlhldHcxaDVtNkdkeW1BMXR6ajRLUmI5QU9oZEY2cDdKcHg5QVgrN2RzKzV1TllTRzlqWUFvalNUXG5xTjRKOFRmSnZFbHpOVEUweVhQaFhQV3hiVGgxWjlIbFc1bTZ4R0NabFFLQmdRRHRhNHZ0ZVpwaEFJNEx6akRXXG5ITkF5SXV3YjdGMFNyQVZMUnNqYjNtZ0xBdStNSHVHem9Da3FuQjB6ODRMdnlmOU1WWUF6cnJ1YStyQWhnSy9vXG5XMmk5cjRxOEtOQ0xSWndCaUNENko3NlU3dCtsc3pvTXVtM3c3dVpsanA4RmlKek5LR1JmemhPWE10WmVzVmpuXG5iUVN3NlhJaksvajdGSkszNmpRc0lLQ3l4UUtCZ1FETDFtWG9DVlFKeWR3VFlLcVBKTUJMOW5WWmhqRUMrNi84XG51MG1wMGVKSDBvZGZjYnRIOGh6cVZnZk41ZkVSWFZlOXdDcC9ocjYzRmt1dzFpM0NCMHg4ZFhOZVVFTmpZeVR3XG5Cb1pEbm9QQ05mckhkdVpqVGYxNG45YkUyVXRIeDY2T3hUZHo4anhCVFFlTVgrd0VZU1cyNE5NTU1NMURZcEwxXG50c3hVUmliUlZRS0JnUUNIUWJXOTNJRXVzZm82ajRVUzllZEdLTThLT1dYc3RVTnUxeXltMWRYQU1EUDRSNytkXG5iYWtHTlZvTnRyVHBsdEp5MG1MdkRxU2liaDdaZDA2L3VSTzZ2TDcwNHV1cjdFUXNPemxPU2tZdzRzVld5UHhSXG5OQVJlTmp2YnI1eTRzbE5pTFpqQlc4MmRYY0R5d1dZOHNjYnlZb3c3clZseThRMkU2VkEvczNiWllRS0JnUURMXG55MEE1bkZIME0yaWZ5dzdiYktBQmtwaEMrR0k2SEU4WWZGdXF1SmZtdlByeGx2RHFmb3NnVXdFY2YxL2t2NUZBXG51a2NERjBISUpUZHB4c2thNjFjeU8rOHJoVTNLcVU0OTJCZ1d0UDRBaHgyQ25VSzhXRFlxaW93Y1pTL1p4UytsXG51RkczejZFa25KSUdhOFM1b0RNbncySGVGMUN4cFhWT3l3TkE0cDVldlFLQmdIdzZwUWJXazM4S2RqUmNPNEo3XG5QYmxMMUxvcVZIOVhhRVQ3NWs1N3F4K0F5ZWYyQWlYSDh5emxxeTVCbFc2d2NpZTNSc0M1emtYc2JoZlFBWFdtXG5LbjhFQzZUcm9FenZkb0NWU2tKRk1qb3B5V2tPR0RDTTZEYnVYbWxmY1V3ZlVtSXdyVUJpTzBZNnRZam0xZGNJXG5mMkZpSWtHRi9PTVdzSHh5aFNXSmIrWmFcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsImNsaWVudF9lbWFpbCI6ImZpcmViYXNlLWFkbWluc2RrLXB3eGR2QGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImNsaWVudF9pZCI6IjEwMjYzMTI5MTMwMTUzMjU1NzAwMyIsImF1dGhfdXJpIjoiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCJ0b2tlbl91cmkiOiJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsImNsaWVudF94NTA5X2NlcnRfdXJsIjoiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay1wd3hkdiU0MGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSJ9'\n\nif (firebaseAdmin.apps.length === 0) {\n    firebaseAdmin.initializeApp({\n        credential: firebaseAdmin.credential.cert(\n            JSON.parse(Buffer.from(configData, 'base64').toString('ascii'))),\n    });\n}\n\nconst firestore = firebaseAdmin.firestore()\n\nconst docRef = msg.payload.ref;\nconst data = { ...msg.payload.data(), id: msg.payload.id };\ndocRef.update({ isSend: true });\n\n\nconst doStuffs = async () => {\n    const getPublisher = async (uid) => {\n        try {\n            const snapshot = await firestore.collection('users').doc(uid).get();\n            if (snapshot.exists) {\n                const userData = snapshot.data();\n                return userData;\n            } else {\n                // Document with the given UID does not exist\n                return null;\n            }\n        } catch (error) {\n            console.error('Error fetching getPublisher:', error);\n            return null;\n        }\n    };\n\n    const announcementPublisher = await getPublisher(data.publishedBy);\n\n    // Update the note field of all relevant documents in the groups collection\n    const batch = firestore.batch();\n    const announcementTime = data.announcementTime.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });\n\n    data.recipients.groupsIds.forEach(groupId => {\n        const groupRef = firestore.collection('groups').doc(groupId);\n        batch.update(groupRef, {\n            message: `${announcementPublisher ? announcementPublisher.displayName : 'UNKNOWN'}: ${data.note}`,\n            time: announcementTime,\n            lastAnnouncementSend: false\n        });\n    });\n\n\n    const getClassroomsIds = async () => {\n        const classroomIdsArray = data.recipients.classroomIds;\n        const groupIdsArray = data.recipients.groupsIds;\n\n        const groupsRef = firestore.collection('groups')\n        if (groupIdsArray.length > 0) {\n            return groupsRef.where(firebaseAdmin.firestore.FieldPath.documentId(), 'in', groupIdsArray).get()\n                .then(snapshot => {\n                    snapshot.forEach(doc => {\n                        doc.data().classroomIds.forEach(classroomId => {\n                            classroomIdsArray.push(classroomId)\n                        })\n                    });\n\n                    const classroomIds = Array.from(new Set(classroomIdsArray))\n                    return classroomIds\n\n                })\n                .catch(error => {\n                    console.error('Error fetching classroom documents:', error);\n                    return classroomIdsArray;\n                });\n        } else {\n            return classroomIdsArray\n        }\n    }\n\n    const fetchClassrooms = async (_classroomsIds) => {\n        const classroomRef = firestore.collection('devices')\n        const _classroomsItems = []\n        return classroomRef.where(firebaseAdmin.firestore.FieldPath.documentId(), 'in', _classroomsIds).get()\n            .then(snapshot => {\n                snapshot.forEach(classroomDoc => {\n                    _classroomsItems.push({ ...classroomDoc.data(), id: classroomDoc.id })\n                });\n\n                return _classroomsItems\n\n            })\n            .catch(error => {\n                console.error('Error fetching classroom documents:', error);\n                return _classroomsItems;\n            });\n    }\n\n    const classroomsIdsArray = await getClassroomsIds();\n    classroomsIdsArray.forEach(classroomId => {\n        const classroomRef = firestore.collection('devices').doc(classroomId);\n        batch.update(classroomRef, {\n            message: `${announcementPublisher ? announcementPublisher.displayName : 'UNKNOWN'}: ${data.note}`,\n            time: announcementTime,\n            lastAnnouncementSend: false\n        });\n    });\n\n    const classroomsArray = await fetchClassrooms(classroomsIdsArray)\n    batch.commit().then(() => {\n        msg.payload = { announcement: data, recipients: classroomsArray };\n        node.send(msg);\n    });\n\n}\ndoStuffs()",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 60,
        "wires": [
            [
                "e3097dcf95be2c49"
            ]
        ],
        "outputLabels": [
            "1"
        ]
    },
    {
        "id": "04c3192ad21e0ec4",
        "type": "websocket in",
        "z": "fd8e8b6fa29d6f79",
        "name": "",
        "server": "3ce080af1180e0bb",
        "client": "",
        "x": 90,
        "y": 120,
        "wires": [
            [
                "d4bab76172439c27",
                "fd05e9f4de9743a7"
            ]
        ]
    },
    {
        "id": "d4bab76172439c27",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "Connected",
        "func": "let received_msg = JSON.parse(msg.payload)\nif (received_msg.command == 'connected') {\n    msg.payload = {\n        classroom_code: received_msg.classroom_code,\n        websocket_id: msg._session.id\n    }\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 120,
        "wires": [
            [
                "0e4391c1834b5817"
            ]
        ]
    },
    {
        "id": "0e4391c1834b5817",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "Update Devices",
        "func": "var firebaseAdmin = global.get('firebaseAdmin');\nconst configData = 'eyJ0eXBlIjoic2VydmljZV9hY2NvdW50IiwicHJvamVjdF9pZCI6ImNhbXB1c2Nhc3QtZWxhYmlucyIsInByaXZhdGVfa2V5X2lkIjoiMWZkYzY4NTFjOGRhYWFhM2UyYjlmMzZmZDRkOTNiYWZlYzI2ZjY4YiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM5Q3g1ZTZFTktjZVB3XG5LcGcwT2Y0MVIwYXVaQ2I1aDdHU0lBdEliaEJoZmdEUlNrL2R5WERlYmw2cmRyNXQ1dmpEY2dvZW04cVA5T0YyXG5nRHBkUVZ6dUtiKzNiY093Z2N4b3F6KzQ3dXVRZGlQSXY3cFBoWU1ZNW9mUEF0YjJHV1pFV29GOWIyUDgwbUo4XG5NUzA5NWxHNjJieDNzWUtYeFBseDk5eXo2dTVwNVZIS3A1YWZhZXZMUjU0VTdnaXY0bU03UVVwWTVydG9ZZm5FXG5jV05wRTNDaU8rdmlidW9KRktYaFNDQjlRZzUxanlwRmVBTHFBeWZDS0pXcktBT2ZXZW9XOExKNlNXRCtpcTNWXG5yKzc5WHRYeU16ODNETkdqSXV3NVdWOWIzWFUvVWdxVlBkVkFyblZ4aVR6MWs5cmxPOHlwYTErMHl1U1lEM2tSXG54cXB1akRCcEFnTUJBQUVDZ2dFQUtxc3ZDblJwdGN5aGltU08wS0R6VmdLMXV5aDdYSkNLWGFWU2JxRjdISW8wXG5kSWpOb0kxMlpwb3FUNURBZUMxdElpNGtCeGNhWUNaQlduNGtUa2F4eTBiTWtVSWE3SVRMaHFkNmZVc2VDOUFDXG5rUzNuUjBvbkZqQjRZRnJ2ZW9JdW9VaDlXRHJUYW0zeEVUK0hTdVNvdDJBc2FDYStoM09MNnZPclVzZTQwdGt1XG5aVk1DMktNdXNhdU0yRERHUnlFQWN3WWl0M0EwVDFvYlVEZ1oydnEzK1c5UXZHY0NLRHBGSDlqQk1tOVFkUUo1XG5qMWlMd0QrdlhldHcxaDVtNkdkeW1BMXR6ajRLUmI5QU9oZEY2cDdKcHg5QVgrN2RzKzV1TllTRzlqWUFvalNUXG5xTjRKOFRmSnZFbHpOVEUweVhQaFhQV3hiVGgxWjlIbFc1bTZ4R0NabFFLQmdRRHRhNHZ0ZVpwaEFJNEx6akRXXG5ITkF5SXV3YjdGMFNyQVZMUnNqYjNtZ0xBdStNSHVHem9Da3FuQjB6ODRMdnlmOU1WWUF6cnJ1YStyQWhnSy9vXG5XMmk5cjRxOEtOQ0xSWndCaUNENko3NlU3dCtsc3pvTXVtM3c3dVpsanA4RmlKek5LR1JmemhPWE10WmVzVmpuXG5iUVN3NlhJaksvajdGSkszNmpRc0lLQ3l4UUtCZ1FETDFtWG9DVlFKeWR3VFlLcVBKTUJMOW5WWmhqRUMrNi84XG51MG1wMGVKSDBvZGZjYnRIOGh6cVZnZk41ZkVSWFZlOXdDcC9ocjYzRmt1dzFpM0NCMHg4ZFhOZVVFTmpZeVR3XG5Cb1pEbm9QQ05mckhkdVpqVGYxNG45YkUyVXRIeDY2T3hUZHo4anhCVFFlTVgrd0VZU1cyNE5NTU1NMURZcEwxXG50c3hVUmliUlZRS0JnUUNIUWJXOTNJRXVzZm82ajRVUzllZEdLTThLT1dYc3RVTnUxeXltMWRYQU1EUDRSNytkXG5iYWtHTlZvTnRyVHBsdEp5MG1MdkRxU2liaDdaZDA2L3VSTzZ2TDcwNHV1cjdFUXNPemxPU2tZdzRzVld5UHhSXG5OQVJlTmp2YnI1eTRzbE5pTFpqQlc4MmRYY0R5d1dZOHNjYnlZb3c3clZseThRMkU2VkEvczNiWllRS0JnUURMXG55MEE1bkZIME0yaWZ5dzdiYktBQmtwaEMrR0k2SEU4WWZGdXF1SmZtdlByeGx2RHFmb3NnVXdFY2YxL2t2NUZBXG51a2NERjBISUpUZHB4c2thNjFjeU8rOHJoVTNLcVU0OTJCZ1d0UDRBaHgyQ25VSzhXRFlxaW93Y1pTL1p4UytsXG51RkczejZFa25KSUdhOFM1b0RNbncySGVGMUN4cFhWT3l3TkE0cDVldlFLQmdIdzZwUWJXazM4S2RqUmNPNEo3XG5QYmxMMUxvcVZIOVhhRVQ3NWs1N3F4K0F5ZWYyQWlYSDh5emxxeTVCbFc2d2NpZTNSc0M1emtYc2JoZlFBWFdtXG5LbjhFQzZUcm9FenZkb0NWU2tKRk1qb3B5V2tPR0RDTTZEYnVYbWxmY1V3ZlVtSXdyVUJpTzBZNnRZam0xZGNJXG5mMkZpSWtHRi9PTVdzSHh5aFNXSmIrWmFcbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsImNsaWVudF9lbWFpbCI6ImZpcmViYXNlLWFkbWluc2RrLXB3eGR2QGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImNsaWVudF9pZCI6IjEwMjYzMTI5MTMwMTUzMjU1NzAwMyIsImF1dGhfdXJpIjoiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCJ0b2tlbl91cmkiOiJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsImNsaWVudF94NTA5X2NlcnRfdXJsIjoiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay1wd3hkdiU0MGNhbXB1c2Nhc3QtZWxhYmlucy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSJ9'\n\nif (firebaseAdmin.apps.length === 0) {\n    firebaseAdmin.initializeApp({\n        credential: firebaseAdmin.credential.cert(\n            JSON.parse(Buffer.from(configData, 'base64').toString('ascii'))),\n    });\n}\n\nconst firestore = firebaseAdmin.firestore()\n\nfirestore.collection('devices')\n    .where('classroomCode', '==', msg.payload.classroom_code)\n    .get()\n    .then((querySnapshot) => {\n        node.warn(querySnapshot.length);\n        querySnapshot.forEach((doc) => {\n            console.log(doc.id, ' => ', doc.data());\n\n            const deviceRef = doc.ref;\n            deviceRef.update({ websocketId: msg.payload.websocket_id })\n                .then(() => {\n                    console.log('websocketId updated successfully');\n                })\n                .catch((error) => {\n                    console.error('Error updating websocketId: ', error);\n                });\n        });\n    })\n    .catch((error) => {\n        console.error('Error getting documents: ', error);\n    });\n\n// const db = firebaseAdmin.firestore();\n// const announcementsRef = db.collection('announcements');\n\n// db.collection(\"announcements\").doc(\"k6UIbKUA0UbNbcJDDQi3\")\n//     .onSnapshot((doc) => {\n//         console.log(\"Current data: \", doc.data());\n//     });\n\n// const firestore = firebaseAdmin.firestore();\n\n// firestore.listCollections().then(collections => {\n//     collections.forEach(collection => {\n//         console.log('Collection:', collection.id);\n//     });\n// }).catch(error => {\n//     console.error('Error listing collections:', error);\n// });\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 120,
        "wires": [
            []
        ],
        "outputLabels": [
            "1"
        ]
    },
    {
        "id": "e3097dcf95be2c49",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "Send WS Message",
        "func": "msg.payload.recipients.map(recipient => {\n    const ws_msg = {\n        command: 'anncmnt',\n        audioUrl: msg.payload.announcement.audioUrl,\n        id: msg.payload.announcement.id\n    }\n    node.send({\n        payload: ws_msg,\n        _session: {\n            id: recipient.websocketId\n        }\n    });\n})\n// node.warn(msg.payload.recipients);\n// return msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 60,
        "wires": [
            [
                "56c6dea0cf95419a"
            ]
        ]
    },
    {
        "id": "56c6dea0cf95419a",
        "type": "websocket out",
        "z": "fd8e8b6fa29d6f79",
        "name": "",
        "server": "3ce080af1180e0bb",
        "client": "",
        "x": 850,
        "y": 60,
        "wires": []
    },
    {
        "id": "fd05e9f4de9743a7",
        "type": "function",
        "z": "fd8e8b6fa29d6f79",
        "name": "ACK",
        "func": "let received_msg = JSON.parse(msg.payload)\nif (received_msg.command == 'ack') {\n    msg.payload = {\n        classroom_code: received_msg.classroom_code,\n        // websocket_id: msg._session.id\n        msg_id: received_msg.msg_id\n    }\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 160,
        "wires": [
            [
                "07fa6b08b17df0b7"
            ]
        ]
    },
    {
        "id": "07fa6b08b17df0b7",
        "type": "debug",
        "z": "fd8e8b6fa29d6f79",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 160,
        "wires": []
    },
    {
        "id": "80d474cda2178377",
        "type": "debug",
        "z": "fd8e8b6fa29d6f79",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 760,
        "y": 160,
        "wires": []
    }
]